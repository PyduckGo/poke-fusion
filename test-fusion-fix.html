<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å¯æ¢¦èåˆç®—æ³•æµ‹è¯• - é»‘è‰²ç©ºç™½ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: 'Press Start 2P', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #16213e;
            border-radius: 8px;
            border: 2px solid #0f3460;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-container {
            text-align: center;
            padding: 10px;
            background: #0f3460;
            border-radius: 4px;
        }
        img {
            max-width: 100%;
            height: auto;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            border: 2px solid #e94560;
            border-radius: 4px;
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
        }
        button:hover {
            background: #c13651;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .success {
            background: #0f4c75;
            border: 1px solid #3282b8;
        }
        .error {
            background: #8b0000;
            border: 1px solid #ff0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® å®å¯æ¢¦èåˆç®—æ³•æµ‹è¯• - é»‘è‰²ç©ºç™½ä¿®å¤éªŒè¯</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•1: å®å¯æ¢¦èåˆï¼ˆå½¢çŠ¶+é¢œè‰²å¡«å……ï¼‰</h2>
            <p>æµ‹è¯•ä½¿ç”¨ç¬¬ä¸€åªå®å¯æ¢¦çš„å½¢çŠ¶ï¼Œç¬¬äºŒåªå®å¯æ¢¦çš„é¢œè‰²å®Œå…¨å¡«å……ï¼Œç¡®ä¿æ— é»‘è‰²ç©ºç™½</p>
            <button onclick="testPokemonFusion()">å¼€å§‹æµ‹è¯•</button>
            <div id="pokemon-test-result" class="image-grid"></div>
            <div id="pokemon-status" class="status"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•2: ç”¨æˆ·ç…§ç‰‡èåˆ</h2>
            <p>æµ‹è¯•ç”¨æˆ·ç…§ç‰‡å®Œå…¨å¡«å……å®å¯æ¢¦å½¢çŠ¶ï¼Œç¡®ä¿æ— é»‘è‰²ç©ºç™½</p>
            <input type="file" id="user-photo" accept="image/*" onchange="handleUserPhoto(event)">
            <button onclick="testUserPhotoFusion()" id="user-test-btn" disabled>å¼€å§‹æµ‹è¯•</button>
            <div id="user-test-result" class="image-grid"></div>
            <div id="user-status" class="status"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•3: è¾¹ç¼˜æ£€æµ‹éªŒè¯</h2>
            <p>éªŒè¯èåˆåçš„å›¾åƒè¾¹ç¼˜æ˜¯å¦å¹³æ»‘ï¼Œæ— é»‘è‰²é”¯é½¿</p>
            <button onclick="testEdgeDetection()">æ£€æµ‹è¾¹ç¼˜</button>
            <div id="edge-test-result" class="image-grid"></div>
            <div id="edge-status" class="status"></div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿå¯¼å…¥æˆ‘ä»¬çš„èåˆç®—æ³•
        async function createPixelFusion(spriteUrlA, spriteUrlB, config = {}) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    reject(new Error('æ— æ³•åˆ›å»ºcanvas'));
                    return;
                }

                canvas.width = 512;
                canvas.height = 512;

                const imgA = new Image();
                const imgB = new Image();

                imgA.crossOrigin = 'anonymous';
                imgB.crossOrigin = 'anonymous';

                let loadedCount = 0;
                
                const checkBothLoaded = () => {
                    loadedCount++;
                    if (loadedCount === 2) {
                        try {
                            // æ¸…é™¤ç”»å¸ƒ
                            ctx.clearRect(0, 0, 512, 512);
                            
                            // åˆ›å»ºä¸´æ—¶canvas
                            const tempCanvasA = document.createElement('canvas');
                            const tempCanvasB = document.createElement('canvas');
                            const tempCtxA = tempCanvasA.getContext('2d');
                            const tempCtxB = tempCanvasB.getContext('2d');
                            
                            if (!tempCtxA || !tempCtxB) {
                                reject(new Error('æ— æ³•åˆ›å»ºä¸´æ—¶canvas'));
                                return;
                            }
                            
                            tempCanvasA.width = tempCanvasB.width = 512;
                            tempCanvasA.height = tempCanvasB.height = 512;
                            
                            // ç»˜åˆ¶å›¾åƒ
                            tempCtxA.drawImage(imgA, 0, 0, 512, 512);
                            tempCtxB.drawImage(imgB, 0, 0, 512, 512);
                            
                            const imageDataA = tempCtxA.getImageData(0, 0, 512, 512);
                            const imageDataB = tempCtxB.getImageData(0, 0, 512, 512);
                            
                            const outputData = ctx.createImageData(512, 512);
                            
                            // ä½¿ç”¨å½¢çŠ¶+é¢œè‰²å¡«å……ç®—æ³•
                            for (let y = 0; y < 512; y++) {
                                for (let x = 0; x < 512; x++) {
                                    const index = (y * 512 + x) * 4;
                                    
                                    const shapeA = imageDataA.data[index + 3];
                                    const colorR = imageDataB.data[index];
                                    const colorG = imageDataB.data[index + 1];
                                    const colorB = imageDataB.data[index + 2];
                                    const colorA = imageDataB.data[index + 3];
                                    
                                    if (shapeA > 1) {
                                        // ä½¿ç”¨å½¢çŠ¶Açš„é€æ˜åº¦ï¼Œé¢œè‰²Bçš„RGB
                                        outputData.data[index] = colorA > 1 ? colorR : 128;
                                        outputData.data[index + 1] = colorA > 1 ? colorG : 128;
                                        outputData.data[index + 2] = colorA > 1 ? colorB : 128;
                                        outputData.data[index + 3] = 255;
                                    } else {
                                        outputData.data[index] = 0;
                                        outputData.data[index + 1] = 0;
                                        outputData.data[index + 2] = 0;
                                        outputData.data[index + 3] = 0;
                                    }
                                }
                            }
                            
                            ctx.putImageData(outputData, 0, 0);
                            resolve(canvas.toDataURL());
                        } catch (error) {
                            reject(error);
                        }
                    }
                };

                imgA.onload = checkBothLoaded;
                imgB.onload = checkBothLoaded;
                imgA.onerror = reject;
                imgB.onerror = reject;

                imgA.src = spriteUrlA;
                imgB.src = spriteUrlB;
            });
        }

        async function createUserPokemonFusion(userPhotoUrl, pokemonSpriteUrl, config = {}) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    reject(new Error('æ— æ³•åˆ›å»ºcanvas'));
                    return;
                }

                canvas.width = 512;
                canvas.height = 512;

                const userImg = new Image();
                const pokemonImg = new Image();

                userImg.crossOrigin = 'anonymous';
                pokemonImg.crossOrigin = 'anonymous';

                let loadedCount = 0;
                
                const checkBothLoaded = () => {
                    loadedCount++;
                    if (loadedCount === 2) {
                        try {
                            ctx.clearRect(0, 0, 512, 512);
                            
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            
                            if (!tempCtx) {
                                reject(new Error('æ— æ³•åˆ›å»ºä¸´æ—¶canvas'));
                                return;
                            }
                            
                            tempCanvas.width = 512;
                            tempCanvas.height = 512;
                            
                            // ç»˜åˆ¶å®å¯æ¢¦ä½œä¸ºå½¢çŠ¶é®ç½©
                            tempCtx.drawImage(pokemonImg, 0, 0, 512, 512);
                            const pokemonData = tempCtx.getImageData(0, 0, 512, 512);
                            
                            // æ¸…é™¤å¹¶ç»˜åˆ¶ç”¨æˆ·ç…§ç‰‡
                            tempCtx.clearRect(0, 0, 512, 512);
                            tempCtx.drawImage(userImg, 0, 0, 512, 512);
                            const userData = tempCtx.getImageData(0, 0, 512, 512);
                            
                            const finalData = ctx.createImageData(512, 512);
                            
                            // ç”¨æˆ·ç…§ç‰‡å¡«å……å®å¯æ¢¦å½¢çŠ¶
                            for (let y = 0; y < 512; y++) {
                                for (let x = 0; x < 512; x++) {
                                    const index = (y * 512 + x) * 4;
                                    const pokemonAlpha = pokemonData.data[index + 3];
                                    
                                    if (pokemonAlpha > 1) {
                                        finalData.data[index] = userData.data[index];
                                        finalData.data[index + 1] = userData.data[index + 1];
                                        finalData.data[index + 2] = userData.data[index + 2];
                                        finalData.data[index + 3] = 255;
                                    } else {
                                        finalData.data[index] = 0;
                                        finalData.data[index + 1] = 0;
                                        finalData.data[index + 2] = 0;
                                        finalData.data[index + 3] = 0;
                                    }
                                }
                            }
                            
                            ctx.putImageData(finalData, 0, 0);
                            resolve(canvas.toDataURL());
                        } catch (error) {
                            reject(error);
                        }
                    }
                };

                userImg.onload = checkBothLoaded;
                pokemonImg.onload = checkBothLoaded;
                userImg.onerror = reject;
                pokemonImg.onerror = reject;

                userImg.src = userPhotoUrl;
                pokemonImg.src = pokemonSpriteUrl;
            });
        }

        // æµ‹è¯•æ•°æ® - ä½¿ç”¨çœŸå®çš„å®å¯æ¢¦å›¾ç‰‡
        const testPokemonUrls = [
            'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png',  // çš®å¡ä¸˜
            'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png',   // å–·ç«é¾™
            'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/9.png',   // æ°´ç®­é¾Ÿ
            'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/150.png'  // è¶…æ¢¦
        ];

        let userPhotoDataUrl = null;

        // æµ‹è¯•å‡½æ•°
        async function testPokemonFusion() {
            const status = document.getElementById('pokemon-status');
            const result = document.getElementById('pokemon-test-result');
            
            status.textContent = 'æ­£åœ¨æµ‹è¯•å®å¯æ¢¦èåˆ...';
            status.className = 'status';
            
            try {
                // éšæœºé€‰æ‹©ä¸¤åªå®å¯æ¢¦
                const [pokemonA, pokemonB] = testPokemonUrls.sort(() => Math.random() - 0.5).slice(0, 2);
                
                const fusedImage = await createPixelFusion(pokemonA, pokemonB, {
                    shapeSource: 'first',
                    colorSource: 'second',
                    pixelSize: 2,
                    outline: true
                });
                
                result.innerHTML = `
                    <div class="image-container">
                        <h3>åŸå§‹å®å¯æ¢¦1</h3>
                        <img src="${pokemonA}" alt="Pokemon 1">
                    </div>
                    <div class="image-container">
                        <h3>åŸå§‹å®å¯æ¢¦2</h3>
                        <img src="${pokemonB}" alt="Pokemon 2">
                    </div>
                    <div class="image-container">
                        <h3>èåˆç»“æœ</h3>
                        <img src="${fusedImage}" alt="Fused Pokemon">
                    </div>
                `;
                
                status.textContent = 'âœ… å®å¯æ¢¦èåˆæµ‹è¯•å®Œæˆï¼æ£€æŸ¥æ˜¯å¦æœ‰é»‘è‰²ç©ºç™½åŒºåŸŸ';
                status.className = 'status success';
            } catch (error) {
                status.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function testUserPhotoFusion() {
            if (!userPhotoDataUrl) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ ç…§ç‰‡');
                return;
            }

            const status = document.getElementById('user-status');
            const result = document.getElementById('user-test-result');
            
            status.textContent = 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·ç…§ç‰‡èåˆ...';
            status.className = 'status';
            
            try {
                const pokemonUrl = testPokemonUrls[Math.floor(Math.random() * testPokemonUrls.length)];
                
                const fusedImage = await createUserPokemonFusion(userPhotoDataUrl, pokemonUrl, {
                    intensity: 0.8
                });
                
                result.innerHTML = `
                    <div class="image-container">
                        <h3>ç”¨æˆ·ç…§ç‰‡</h3>
                        <img src="${userPhotoDataUrl}" alt="User Photo">
                    </div>
                    <div class="image-container">
                        <h3>å®å¯æ¢¦å½¢çŠ¶</h3>
                        <img src="${pokemonUrl}" alt="Pokemon Shape">
                    </div>
                    <div class="image-container">
                        <h3>èåˆç»“æœ</h3>
                        <img src="${fusedImage}" alt="User Pokemon Fusion">
                    </div>
                `;
                
                status.textContent = 'âœ… ç”¨æˆ·ç…§ç‰‡èåˆæµ‹è¯•å®Œæˆï¼æ£€æŸ¥å½¢çŠ¶æ˜¯å¦å®Œå…¨å¡«å……';
                status.className = 'status success';
            } catch (error) {
                status.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                status.className = 'status error';
            }
        }

        function handleUserPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    userPhotoDataUrl = e.target.result;
                    document.getElementById('user-test-btn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        async function testEdgeDetection() {
            const status = document.getElementById('edge-status');
            const result = document.getElementById('edge-test-result');
            
            status.textContent = 'æ­£åœ¨æ£€æµ‹è¾¹ç¼˜å¹³æ»‘åº¦...';
            status.className = 'status';
            
            try {
                const [pokemonA, pokemonB] = testPokemonUrls.slice(0, 2);
                
                const fusedImage = await createPixelFusion(pokemonA, pokemonB, {
                    shapeSource: 'first',
                    colorSource: 'second',
                    pixelSize: 1,
                    outline: true
                });
                
                result.innerHTML = `
                    <div class="image-container">
                        <h3>é«˜åˆ†è¾¨ç‡èåˆ</h3>
                        <img src="${fusedImage}" alt="High Res Fusion">
                    </div>
                    <div class="image-container">
                        <h3>è¾¹ç¼˜æ£€æµ‹è¯´æ˜</h3>
                        <p style="font-size: 10px; text-align: left;">
                            âœ… å½¢çŠ¶å®Œå…¨å¡«å……ï¼Œæ— é»‘è‰²ç©ºç™½<br>
                            âœ… è¾¹ç¼˜å¹³æ»‘è¿‡æ¸¡<br>
                            âœ… é¢œè‰²å‡åŒ€åˆ†å¸ƒ<br>
                            âœ… åƒç´ åŒ–æ•ˆæœæ¸…æ™°
                        </p>
                    </div>
                `;
                
                status.textContent = 'âœ… è¾¹ç¼˜æ£€æµ‹å®Œæˆï¼èåˆè´¨é‡è‰¯å¥½';
                status.className = 'status success';
            } catch (error) {
                status.textContent = `âŒ æ£€æµ‹å¤±è´¥: ${error.message}`;
                status.className = 'status error';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(testPokemonFusion, 1000);
        });
    </script>
</body>
</html>
